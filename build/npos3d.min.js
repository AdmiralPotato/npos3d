var NPos3d=NPos3d||{addFunc:function(e){var t,n,o=this;if(e.parent&&e.parent.remove(e),void 0===o.children)o.children=[];else for(t=o.children.length,n=0;t>n;n+=1)if(o.children[n]===e)return!1;if(void 0===o.childrenToBeAdded)o.childrenToBeAdded=[];else for(t=o.childrenToBeAdded.length,n=0;t>n;n+=1)if(o.childrenToBeAdded[n]===e)return!1;return o.childrenToBeAdded.push(e),!0},removeFunc:function(e){void 0!==e.onRemove&&e.onRemove(),e.expired=!0},destroyFunc:function(){void 0!==this.onRemove&&this.onRemove(),this.expired=!0},updateMatricesFunc:function(e){var t=this,n=NPos3d.Maths,o=t.parent;n.mat4P3Scale(n.__mat4Identity,t.scale,t.matrices.localScale),n.eulerToMat4(t.rot,t.rotOrder,t.matrices.localRotation),n.mat4Set(t.matrices.localComposite,t.matrices.localScale),n.mat4Mul(t.matrices.localComposite,t.matrices.localRotation,t.matrices.localComposite),n.mat4P3Translate(t.matrices.localComposite,t.pos,t.matrices.localComposite),o&&!o.isScene?n.mat4Mul(t.matrices.localComposite,o.matrices.globalComposite,t.matrices.globalComposite):void 0!=e?n.mat4Mul(t.matrices.localComposite,o.viewMatrix,t.matrices.globalComposite):n.mat4Set(t.matrices.globalComposite,t.matrices.localComposite),n.p3Mat4Mul([0,0,0],t.matrices.globalComposite,t.gPos),n.p3Mat4Mul(t.scale,t.matrices.globalComposite,t.gScale)},recursivelyUpdateMatrices:function e(t){t.parent&&!t.parent.isScene&&e(t.parent),t.updateMatrices()},transformPoints:function(e,t){var n,o=NPos3d.Maths;for(n=0;n<e.shape.points.length;n+=1)t[n]=o.p3Mat4Mul(e.shape.points[n],e.matrices.globalComposite,t[n])},getTransformedPointsFunc:function(){var e=this,t=[];return e.shape&&e.shape.points&&e.shape.points.length&&(NPos3d.recursivelyUpdateMatrices(e),NPos3d.transformPoints(e,t)),t},getWorldPositionFunc:function(){return NPos3d.recursivelyUpdateMatrices(this),NPos3d.Maths.p3Mat4Mul([0,0,0],this.matrices.globalComposite)},renderFunc:function(){var e=this;if(e.updateMatrices(e,e.scene.viewMatrix),e.shape&&e.shape.points&&e.shape.points.length){if(e.scene.updateTransformedPointCache(e),e.transformedPointCache.length>0&&(("both"===e.renderStyle||"lines"===e.renderStyle)&&e.transformedPointCache.length>1&&void 0!==e.shape.lines&&"number"==typeof e.shape.lines.length&&e.shape.lines.length>0&&e.scene.drawLines(e),("both"===e.renderStyle||"points"===e.renderStyle)&&e.scene.drawPoints(e),"both"!==e.renderStyle&&"lines"!==e.renderStyle&&"points"!==e.renderStyle))throw"Invalid renderStyle specified: "+e.renderStyle}else e.transformedPointCache.length=0;e.postRender&&e.postRender()}};NPos3d.Maths={pi:Math.PI,tau:2*Math.PI,deg:Math.PI/180,sin:Math.sin,cos:Math.cos,square:function(e){return e*e},pointInNBounds:function(e,t){var n;for(n=0;n<e.length;n+=1)if(e[n]<t[0][n]||e[n]>t[1][n])return!1;return!0},pointIn2dBounds:function(e,t){return e[0]<t[0][0]||e[0]>t[1][0]||e[1]<t[0][1]||e[1]>t[1][1]?!1:!0},pointIn3dBounds:function(e,t){return e[0]<t[0][0]||e[0]>t[1][0]||e[1]<t[0][1]||e[1]>t[1][1]||e[2]<t[0][2]||e[2]>t[1][2]?!1:!0},getSquareVecLength2D:function(e,t){return NPos3d.Maths.square(e)+NPos3d.Maths.square(t)},getVecLength2D:function(e,t){return Math.sqrt(NPos3d.Maths.getSquareVecLength2D(e,t))},getRelativeAngle3D:function(e){var t=Math.atan2(e[1],e[0]),n=NPos3d.Maths.getVecLength2D(e[0],e[1]),o=-Math.atan2(e[2],n);return[0,o,t]},p3Add:function(e,t,n){var o=n||[];return o[0]=e[0]+t[0],o[1]=e[1]+t[1],o[2]=e[2]+t[2],o[3]=e[3],o},p3Sub:function(e,t,n){var o=n||[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],o[3]=e[3],o},pointAt:function(e,t){var n=NPos3d.Maths,o=n.p3Sub(t,e.gPos);e.rotOrder!==[2,1,0]&&(e.rotOrder=[2,1,0]),e.rot=n.getRelativeAngle3D(o)},__mat4Identity:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],makeMat4:function(){return this.__mat4Identity.slice()},mat3ToMat4Translation:[[0,1,2],[4,5,6],[8,9,10]],rotOrders:{"0,1,2":[0,1,2,0],"0,2,1":[0,2,1,1],"1,0,2":[1,0,2,1],"1,2,0":[1,2,0,0],"2,0,1":[2,0,1,0],"2,1,0":[2,1,0,1]},eulerToMat4:function(e,t,n){var o,i,r,s,a,l,c,p,d,h,u,f,m,g=this,y=n||g.makeMat4(),v=g.mat3ToMat4Translation,w=e.toString(),x=t.toString(),S=g.rotOrders[x],P=S[0],b=S[1],M=S[2],N=S[3];return y.euler!==w&&y.rotOrder!==x&&(y.euler=w,y.order=x,"0,0,0"===w?(y[0]=1,y[1]=0,y[2]=0,y[4]=0,y[5]=1,y[6]=0,y[8]=0,y[9]=0,y[10]=1):(N?(o=e[P],i=e[b],r=e[M]):(o=-e[P],i=-e[b],r=-e[M]),s=g.cos(o),a=g.cos(i),l=g.cos(r),c=g.sin(o),p=g.sin(i),d=g.sin(r),h=s*l,u=s*d,f=c*l,m=c*d,y[v[P][P]]=a*l,y[v[b][P]]=p*f-u,y[v[M][P]]=p*h+m,y[v[P][b]]=a*d,y[v[b][b]]=p*m+h,y[v[M][b]]=p*u-f,y[v[P][M]]=-p,y[v[b][M]]=a*c,y[v[M][M]]=a*s)),y},mat4Set:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e.euler=t.euler,e.order=t.order,e},mat4Mul:function(e,t,n){var o=e[0],i=e[1],r=e[2],s=e[3],a=e[4],l=e[5],c=e[6],p=e[7],d=e[8],h=e[9],u=e[10],f=e[11],m=e[12],g=e[13],y=e[14],v=e[15],w=t[0],x=t[1],S=t[2],P=t[3],b=t[4],M=t[5],N=t[6],C=t[7],T=t[8],A=t[9],k=t[10],F=t[11],R=t[12],D=t[13],L=t[14],B=t[15],W=n||[];return W[0]=w*o+x*a+S*d+P*m,W[1]=w*i+x*l+S*h+P*g,W[2]=w*r+x*c+S*u+P*y,W[3]=w*s+x*p+S*f+P*v,W[4]=b*o+M*a+N*d+C*m,W[5]=b*i+M*l+N*h+C*g,W[6]=b*r+M*c+N*u+C*y,W[7]=b*s+M*p+N*f+C*v,W[8]=T*o+A*a+k*d+F*m,W[9]=T*i+A*l+k*h+F*g,W[10]=T*r+A*c+k*u+F*y,W[11]=T*s+A*p+k*f+F*v,W[12]=R*o+D*a+L*d+B*m,W[13]=R*i+D*l+L*h+B*g,W[14]=R*r+D*c+L*u+B*y,W[15]=R*s+D*p+L*f+B*v,W},mat4P3Translate:function(e,t,n){var o=n||this.makeMat4(),i=e[3],r=e[7],s=e[11],a=t[0],l=t[1],c=t[2];return o[3]=i+a,o[7]=r+l,o[11]=s+c,o},mat4P3Scale:function(e,t,n){var o=n||this.makeMat4(),i=t[0],r=t[1],s=t[2],a=e[0],l=e[1],c=e[2],p=e[3],d=e[4],h=e[5],u=e[6],f=e[7],m=e[8],g=e[9],y=e[10],v=e[11];return o[0]=a*i,o[1]=l*i,o[2]=c*i,o[3]=p*i,o[4]=d*r,o[5]=h*r,o[6]=u*r,o[7]=f*r,o[8]=m*s,o[9]=g*s,o[10]=y*s,o[11]=v*s,o},p3Mat4Mul:function(e,t,n){var o=n||[],i=e[0],r=e[1],s=e[2],a=e[3]||!1;return o[0]=i*t[0]+r*t[1]+s*t[2]+t[3],o[1]=i*t[4]+r*t[5]+s*t[6]+t[7],o[2]=i*t[8]+r*t[9]+s*t[10]+t[11],o[3]=a,o},__matrix:!1,p3Rotate:function(e,t,n){var o=NPos3d.Maths;return o.__matrix||(o.__matrix=o.makeMat4()),o.eulerToMat4(t,n,o.__matrix),o.p3Mat4Mul(e,o.__matrix)},getP3Scaled:function(e,t){return[e[0]*t[0],e[1]*t[1],e[2]*t[2]]},getP2Offset:function(e,t){return[e[0]+t[0],e[1]+t[1]]},getP3String:function(e){return"x: "+e[0]+" y: "+e[1]+" z: "+e[2]},nGetBounds:function(e){if(e.length<1)return[[0,0,0],[0,0,0]];for(var t=[],n=[],o=e[0],i=0;i<o.length;i+=1)t[i]=o[i],n[i]=o[i];for(var r=1;r<e.length;r+=1)for(var o=e[r],i=0;i<o.length;i+=1)o[i]<t[i]?t[i]=o[i]:o[i]>n[i]&&(n[i]=o[i]);return[t,n]},makeBBCubeFromTwoPoints:function(e,t){return[[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],t[2]],[e[0],t[1],t[2]],[e[0],e[1],e[2]],[t[0],e[1],e[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]]]}},NPos3d.Utils={subset:function(e,t){var n,o={},i=t.split(",");for(n=0;n<i.length;n+=1)o[i[n]]=e[i[n]];return o},initVal:function(){var e;if(arguments.length<1)throw"ur doin it wrong. initVal function requires > 1 arguments";for(e=0;e<arguments.length;e+=1)if(void 0!==arguments[e]&&null!==arguments[e])return arguments[e];return arguments[e]},get_type:function(e){return null===e?"[object Null]":Object.prototype.toString.call(e)},displayDebug:function(e){var t,n=NPos3d.Utils,o=[];n.get_type(e).match(/Number/i)?o.push(e+"<br>"):o.push(e.constructor.name+"<br>");for(t in e)e.hasOwnProperty(t)&&o.push(t.toString()+": "+n.get_type(e[t])+" - "+e[t]+"<br>");n.display||(n.display=document.createElement("pre"),n.display.style.display="block",n.display.style.position="fixed",n.display.style.top=0,n.display.style.left=0,n.display.style.zIndex=9001,n.display.style.fontFamily="monospace",n.display.style.fontSize="10px",n.display.style.lineHeight="7px",n.display.style.whiteSpace="pre-wrap",n.display.style.color="hsl("+Math.round(360*Math.random())+",100%,50%)"),document.body.appendChild(n.display),n.display.innerHTML+=o.join("\n")},clearDebug:function(){var e=NPos3d.Utils;e.display&&(e.display.innerHTML="",e.display.parentNode===document.body&&document.body.removeChild(e.display))}},NPos3d.Scene=function(e){var t=this,n="Scene";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";return e=e||{},t.debugViewport=e.debugViewport||!1,t.mpos={x:0,y:0},t.frameRate=e.frameRate||30,t.lastFrameRate=t.frameRate,t.pixelScale=e.pixelScale||1,t.globalCompositeOperation=e.globalCompositeOperation||"source-over",t.backgroundColor=e.backgroundColor||"transparent",t.strokeStyle=e.strokeStyle||"#fff",t.fillStyle=e.fillStyle||"#fff",t.lineWidth=e.lineWidth||void 0,t.fullScreen=void 0===e.fullScreen||e.fullScreen===!0?!0:!1,t.oldAndroid=/android 2/i.test(navigator.userAgent),t.mobileSafari=/iphone|ipad|ipod/i.test(navigator.userAgent),t.isMobile=t.oldAndroid||t.mobileSafari||/android|blackberry|mini|windows\sce|palm/i.test(navigator.userAgent),t.isChrome=/Chrome/i.test(navigator.userAgent),t.newChromeMobile=t.isMobile&&t.isChrome&&parseInt(navigator.userAgent.match(/Chrome\/(\d*)/i)[1])>18,t.mobileFireFox=t.isMobile&&/firefox/i.test(navigator.userAgent),t.useOuterWidth=t.oldAndroid||t.mobileFireFox,t.canvasId=e.canvasId||"canvas",t.existingCanvas=void 0!==e.canvas,t.canvas=e.canvas||document.createElement("canvas"),t.canvas.style.backgroundColor=e.canvasStyleColor||"#000",t.canvas.id=t.canvasId,t.c=t.canvas.getContext("2d"),void 0===e.canvas&&document.body.appendChild(t.canvas),t.fullScreen?(t.canvas.parentNode.style.margin=0,t.canvas.parentNode.style.padding=0,t.canvas.style.display="block",t.canvas.style.position="fixed",t.canvas.style.top=0,t.canvas.style.left=0,void 0!==e.zIndex&&(t.canvas.style.zIndex=e.zIndex),t.useOuterWidth?t.checkWindow=function(){t.w=Math.ceil(window.outerWidth/t.pixelScale),t.h=Math.ceil(window.outerHeight/t.pixelScale)}:t.checkWindow=function(){t.w=Math.ceil(window.innerWidth/t.pixelScale),t.h=Math.ceil(window.innerHeight/t.pixelScale)}):(t.checkWindow=function(){t.w=Math.ceil(t.canvas.width/t.pixelScale),t.h=Math.ceil(t.canvas.height/t.pixelScale)},""==t.canvas.width&&(t.canvas.width=e.width||512),""==t.canvas.height&&(t.canvas.height=e.height||384)),1!==t.pixelScale&&(t.canvas.style.imageRendering="-moz-crisp-edges",t.canvas.style.imageRendering="-webkit-optimize-contrast",t.c.imageSmoothingEnabled=!1,t.c.mozImageSmoothingEnabled=!1,t.c.webkitImageSmoothingEnabled=!1),t.isMobile||t.existingCanvas||(t.canvas.style.position="fixed"),t.checkWindow(),t.resize(),t.camera=e.camera||new NPos3d.Camera({scene:t}),t.canvas.style.backgroundColor=t.canvasStyleColor,t.cursorPosition=void 0!==e.canvas?"absolute":"relative",t.mouseHandler=function(e){var n=0,o=0,i=window.devicePixelRatio||1,r=0,s=0;if((e.target===t.canvas||e.target===window)&&e.preventDefault(),!t.fullScreen){var a=t.canvas.getBoundingClientRect();n=a.left,o=a.top}e.touches&&e.touches.length?(r=e.touches[0].screenX,s=e.touches[0].screenY):(r=e.clientX,s=e.clientY),(void 0!==i||1!==i)&&(r*=i,s*=i),"absolute"===t.cursorPosition&&(r-=n,s-=o),t.mpos.x=Math.ceil(r/t.pixelScale-t.cx),t.mpos.y=Math.ceil(s/t.pixelScale-t.cy)},window.addEventListener("mousemove",t.mouseHandler,!1),window.addEventListener("touchstart",t.mouseHandler,!1),window.addEventListener("touchmove",t.mouseHandler,!1),t.children=[],t.renderInstructionList=[],t.add(t.camera),t.start(),t.globalize(),this},NPos3d.Scene.prototype={type:"Scene",isScene:!0,globalize:function(){window.pi=NPos3d.Maths.pi,window.tau=NPos3d.Maths.tau,window.deg=NPos3d.Maths.deg,window.sin=NPos3d.Maths.sin,window.cos=NPos3d.Maths.cos,window.square=NPos3d.Maths.square},resize:function(){var e,t,n=this;n.cx=Math.floor(n.w/2),n.cy=Math.floor(n.h/2),n.mpos.x=0,n.mpos.y=0,n.canvas.width=n.w,n.canvas.height=n.h,1!==n.pixelScale?(n.canvas.style.width=Math.ceil(n.w*n.pixelScale)+"px",n.canvas.style.height=Math.ceil(n.h*n.pixelScale)+"px"):(n.canvas.style.width=n.w+"px",n.canvas.style.height=n.h+"px"),n.lw=n.w,n.lh=n.h,n.isMobile&&(e=document.getElementById("vp"),e||(e=document.createElement("meta"),e.setAttribute("name","viewport"),e.setAttribute("id","vp")),e&&e.parentNode===document.head&&document.head.removeChild(e),n.mobileFireFox?e.setAttribute("content","width="+n.w+", user-scalable=no, target-densityDpi=device-dpi"):n.mobileSafari||n.newChromeMobile?(t=1/(window.devicePixelRatio||1),e.setAttribute("content","width=device-width, initial-scale="+t+", minimum-scale="+t+", maximum-scale="+t+", user-scalable=no")):e.setAttribute("content","width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, target-densityDpi=device-dpi"),document.head.appendChild(e))},updateRecursively:function t(e){e.isScene||e.update(),e.children&&e.children.forEach(t)},renderRecursively:function n(e){!e.isScene&&e.render&&e.render(),e.children&&e.children.forEach(n)},removeExpiredChildrenRecursively:function o(e){var t,n,i;if(e.children)for(t=e.children.length,n=t-1;n>=0;n-=1)i=e.children[n],o(i),i.expired&&(e.children.splice(n,1),i.expired=!1,i.parent=!1,i.scene=!1)},addNewChildrenRecursively:function i(e){var t,n,o,r=!1;if(void 0!==e.children&&void 0!==e.children.length&&e.children.length>0)for(t=0;t<e.children.length;t+=1)n=e.children[t],i(n);if(r=e.isScene===!0?e:e.scene,void 0!==e.childrenToBeAdded&&void 0!==e.childrenToBeAdded.length&&e.childrenToBeAdded.length>0){for(t=0;t<e.childrenToBeAdded.length;t+=1)o=e.childrenToBeAdded[t],o.expired?o.expired=!1:(e.children.push(o),o.parent=e,o.scene=r,void 0!==o.onAdd&&o.onAdd());delete e.childrenToBeAdded}},render:function(){var e,t,n,o=this;if(void 0!==o.renderInstructionList&&o.renderInstructionList.length>0)for(t=o.renderInstructionList.length,e=0;t>e;e+=1)n=o.renderInstructionList[e],n.method(o.c,n.args)},update:function(){var e=this,t=(e.children.length,NPos3d.Utils);try{if(e.checkWindow(),(e.w!==e.lw||e.h!==e.lh)&&e.resize(),e.debugViewport){var n=t.subset(window,"innerHeight,innerWidth,outerWidth,outerHeight,devicePixelRatio");n.screenSizeWidth=window.screen.width,n.screenSizeHeight=window.screen.height,n.documentElementClientWidth=document.documentElement.clientWidth,n.documentElementClientHeight=document.documentElement.clientHeight,n.devicePixelRatio=window.devicePixelRatio||1,n.navigator=navigator.userAgent,t.clearDebug(),t.displayDebug(n)}e.renderInstructionList=[],e.addNewChildrenRecursively(e),e.updateRecursively(e),e.viewMatrix=e.inverseMatrix(e.camera),e.renderRecursively(e),e.removeExpiredChildrenRecursively(e),"transparent"===e.backgroundColor?e.c.clearRect(0,0,e.w,e.h):(e.c.fillStyle=e.backgroundColor,e.c.fillRect(0,0,e.w,e.h)),e.c.save(),e.c.globalCompositeOperation=e.globalCompositeOperation,e.c.translate(e.cx,e.cy),e.renderInstructionList.sort(e.sortRenderInstructionByZDepth),e.render(),e.c.restore()}catch(o){e.stop(),console.log(o,o.stack,e)}},start:function(){var e=this;e.interval=setInterval(function(){e.update(),e.frameRate!==e.lastFrameRate&&(e.stop(),e.lastFrameRate=e.frameRate,e.start())},1e3/e.frameRate)},stop:function(){clearInterval(this.interval)},sortRenderInstructionByZDepth:function(e,t){return e.z-t.z},recurseForInheritedProperties:function r(e,t){return void 0!==e[t]?e[t]:e.parent?r(e.parent,t):void 0},drawLine:function(e,t){e.beginPath(),e.moveTo(t.a.x,t.a.y),e.lineTo(t.b.x,t.b.y),e.strokeStyle!==t.color&&(e.strokeStyle=t.color),e.lineWidth!==t.lineWidth&&(e.lineWidth=t.lineWidth),"round"!==e.lineCap&&(e.lineCap="round"),e.stroke()},drawCircle:function(e,t){var n=t.pos.scale*t.pointScale;n>=0&&(e.moveTo(t.pos.x,t.pos.y),e.beginPath(),e.arc(t.pos.x,t.pos.y,n,0,tau,!1),"fill"===t.pointStyle?(e.fillStyle!==t.color&&(e.fillStyle=t.color),e.fill()):"stroke"===t.pointStyle&&(e.strokeStyle!==t.color&&(e.strokeStyle=t.color),e.lineWidth!==t.lineWidth&&(e.lineWidth=t.lineWidth),"round"!==e.lineCap&&(e.lineCap="round"),e.stroke()))},inverseMatrix:function(e){var t=NPos3d.Maths,n=t.makeMat4();do{var o=t.makeMat4();t.eulerToMat4(e.rot.map(function(e){return-e}),e.rotOrder.slice().reverse(),o),t.mat4P3Translate(n,[-e.pos[0],-e.pos[1],-e.pos[2]],n),t.mat4Mul(n,o,n),t.mat4P3Scale(n,e.scale.map(function(e){return-e})),e=e.parent}while(e&&!e.isScene);return n},updateTransformedPointCache:function(e){var t,n=NPos3d.Maths;e.transformedPointCache.length!==e.shape.points.length&&(e.transformedPointCache.length=0,e.lastGlobalCompositeMatrixString=!1),t=e.matrices.globalComposite.toString(),e.lastGlobalCompositeMatrixString&&e.lastGlobalCompositeMatrixString===t||(NPos3d.transformPoints(e,e.transformedPointCache),e.boundingBox=n.nGetBounds(e.transformedPointCache),e.lastGlobalCompositeMatrixString=t)},lineRenderLoop:function(e){var t,n,o,i=this,r=NPos3d.Maths;for(t=0;t<e.shape.lines.length;t+=1)if(n=e.transformedPointCache[e.shape.lines[t][0]],o=e.transformedPointCache[e.shape.lines[t][1]],n[2]<i.camera.clipNear&&o[2]<i.camera.clipNear&&n[2]>i.camera.clipFar&&o[2]>i.camera.clipFar){var s=i.camera.project3Dto2D(n),a=i.camera.project3Dto2D(o),l=[[-i.cx,-i.cy],[i.cx,i.cy]],c=r.pointIn2dBounds([s.x,s.y],l),p=r.pointIn2dBounds([a.x,a.y],l);(c||p)&&i.renderInstructionList.push({method:i.drawLine,args:{a:s,b:a,color:e.shape.lines[t][2]||e.shape.color||e.color||i.strokeStyle,lineWidth:e.lineWidth||e.parent.lineWidth||i.lineWidth||1},z:Math.max(n[2],o[2])})}},drawLines:function(e){var t,n,o,i,r,s,a=this,l=NPos3d.Maths;if(e.renderAlways)return void a.lineRenderLoop(e);if(o=e.boundingBox[0],i=e.boundingBox[1],i[2]>a.camera.clipFar&&o[2]<a.camera.clipNear&&i[2]>a.camera.clipFar&&i[2]<a.camera.clipNear){for(n=l.makeBBCubeFromTwoPoints(o,i),r=!0,t=0;t<n.length&&r;t+=1)s=a.camera.project3Dto2D(n[t]),s.x<a.cx&&s.x>-a.cx&&s.y<a.cy&&s.y>-a.cy&&(r=!1);r||a.lineRenderLoop(e)}},drawPoints:function(e){var t,n,o,i,r,s,a=this,l=NPos3d.Maths;if(e.renderAlways)return void a.pointRenderLoop(e);if(n=e.boundingBox[0],o=e.boundingBox[1],o[2]>a.camera.clipFar&&n[2]<a.camera.clipNear&&o[2]>a.camera.clipFar&&o[2]<a.camera.clipNear){for(i=l.makeBBCubeFromTwoPoints(n,o),r=!0,t=0;t<i.length&&r;t+=1)s=a.camera.project3Dto2D(i[t]),s.x<a.cx&&s.x>-a.cx&&s.y<a.cy&&s.y>-a.cy&&(r=!1);r||a.pointRenderLoop(e)}},pointRenderLoop:function(e){var t,n,o,i,r,s=this,a=NPos3d.Maths;for(t=0;t<e.transformedPointCache.length;t+=1)if(n=e.transformedPointCache[t],n[2]<s.camera.clipNear&&n[2]>s.camera.clipFar){o=s.camera.project3Dto2D(n),i=[[-s.cx,-s.cy],[s.cx,s.cy]];var l=a.pointIn2dBounds([o.x,o.y],i);l&&(r={pos:o,pointScale:e.pointScale,pointStyle:e.pointStyle},"fill"===e.pointStyle?r.color=o.color||e.shape.color||e.color||s.fillStyle:"stroke"===e.pointStyle&&(r.color=o.color||e.shape.color||e.color||s.strokeStyle,r.lineWidth=e.lineWidth||e.scene.lineWidth||1),s.renderInstructionList.push({method:s.drawCircle,args:r,z:n[2]}))}},add:NPos3d.addFunc,remove:NPos3d.removeFunc},NPos3d.Camera=function(e){var t=this,n="Camera";if(e=e||{},t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";if(!e.scene)throw"You must provide a `scene` property when invoking the "+n+" constructor.";NPos3d.blessWith3DBase(t,e),t.clipNear=e.clipNear||-.01,t.clipFar=e.clipFar||-9001,t.frustumMultiplier=e.frustumMultiplier||.75},NPos3d.Camera.prototype={type:"Camera",update:function(){var e=this;e.pos[2]=Math.max(e.scene.w,e.scene.h)*e.frustumMultiplier},project3Dto2D:function(e){var t=this,n=Math.max(t.scene.w,t.scene.h),o=1/-e[2],i={x:e[0]*n*t.frustumMultiplier*o,y:e[1]*n*t.frustumMultiplier*o,scale:n*t.frustumMultiplier*o,color:e[3]||!1};return i}},NPos3d.Geom={cube:{points:[[10,10,10],[10,10,-10],[10,-10,10],[10,-10,-10],[-10,10,10],[-10,10,-10],[-10,-10,10],[-10,-10,-10]],lines:[[0,1],[2,3],[4,5],[6,7],[3,1],[2,0],[7,5],[6,4],[5,1],[7,3],[4,0],[6,2]]},axies:{points:[[4,0,0,"#f00"],[32,0,0,"#f00"],[22,6,-6,"#f00"],[22,-6,6,"#f00"],[0,4,0,"#0f0"],[0,32,0,"#0f0"],[6,22,-6,"#0f0"],[-6,22,6,"#0f0"],[0,0,4,"#00f"],[0,0,32,"#00f"],[-6,6,22,"#00f"],[6,-6,22,"#00f"]],lines:[[0,1,"#f00"],[1,2,"#f00"],[1,3,"#f00"],[4,5,"#0f0"],[5,6,"#0f0"],[5,7,"#0f0"],[8,9,"#00f"],[9,10,"#00f"],[9,11,"#00f"]]}},NPos3d.blessWith3DBase=function(e,t){var n=NPos3d.Maths;e.pos=t.pos||[0,0,0],e.rot=t.rot||[0,0,0],e.rotOrder=t.rotOrder||e.rotOrder||[0,1,2],e.scale=t.scale||e.scale||[1,1,1],e.gPos=e.pos.slice(),e.gScale=e.scale.slice(),e.matrices={localScale:n.makeMat4(),localRotation:n.makeMat4(),localComposite:n.makeMat4(),globalComposite:n.makeMat4()},e.lastGlobalCompositeMatrixString=!1,e.transformedPointCache=[],e.boundingBox=[[0,0,0],[0,0,0]],e.shape=t.shape||e.shape,e.color=t.color||e.color||void 0,e.renderAlways=t.renderAlways||e.renderAlways||!1,e.renderStyle=t.renderStyle||e.renderStyle||"lines",e.pointScale=t.pointScale||e.pointScale||2,e.pointStyle=t.pointStyle||e.pointStyle||"fill",e.lineWidth=t.lineWidth||void 0,e.scene=t.scene,e.expired=!1,e.add=NPos3d.addFunc,e.remove=NPos3d.removeFunc,e.destroy=NPos3d.destroyFunc,e.render=NPos3d.renderFunc,e.getTransformedPoints=NPos3d.getTransformedPointsFunc,e.getWorldPosition=NPos3d.getWorldPositionFunc,e.updateMatrices=NPos3d.updateMatricesFunc},NPos3d.Ob3D=function(e){var t=this,n="Ob3D";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";return e=e||{},NPos3d.blessWith3DBase(t,e),this},NPos3d.Ob3D.prototype={type:"Ob3D",shape:NPos3d.Geom.cube,update:function(){}},NPos3d.Geom.font={"!":{points:[[1,0],[1,2],[1,3],[1,4]],lines:[[0,1],[2,3]]},'"':{points:[[1,1],[1,0],[0,0],[0,1]],lines:[[0,1],[2,3]]},"#":{points:[[2,4],[1,4],[0,3],[0,1],[1,0],[2,0],[2,1],[2,3]],lines:[[0,5],[1,4],[2,7],[3,6]]},$:{points:[[1,0],[1,4],[0,3],[0,1],[2,1],[2,3]],lines:[[0,1],[0,3],[0,4],[1,2],[1,5],[3,5]]},"%":{points:[[0,4],[2,0],[1,4],[2,3],[1,3],[0,1],[1,0],[1,1]],lines:[[0,1],[2,3],[2,4],[3,4],[5,7],[5,6],[6,7]]},"&":{points:[[2,4],[2,1],[0,1],[1,0],[1,2],[2,3],[0,3],[1,4]],lines:[[0,2],[1,3],[2,3],[4,6],[5,7],[6,7]]},"'":{points:[[1,1],[1,0]],lines:[[0,1]]},"(":{points:[[2,0],[2,4],[1,3],[1,1]],lines:[[0,3],[1,2],[2,3]]},")":{points:[[1,1],[1,3],[0,4],[0,0]],lines:[[0,1],[0,3],[1,2]]},"*":{points:[[1,3],[1,1],[0,2],[2,2],[0,3],[2,3],[0,1],[2,1]],lines:[[0,1],[2,3],[4,7],[5,6]]},"+":{points:[[2,2],[0,2],[1,1],[1,3]],lines:[[0,1],[2,3]]},",":{points:[[0,4],[1,3]],lines:[[0,1]]},"-":{points:[[2,2],[0,2]],lines:[[0,1]]},".":{points:[[1,4],[1,3],[0,4]],lines:[[0,2],[0,1],[1,2]]},"/":{points:[[2,1],[0,3]],lines:[[0,1]]},0:{points:[[2,3],[2,1],[0,1],[0,3],[1,4],[1,0]],lines:[[0,4],[0,1],[1,3],[1,5],[2,3],[2,5],[3,4]]},1:{points:[[0,1],[0,4],[2,4],[1,0],[1,4]],lines:[[0,3],[1,2],[3,4]]},2:{points:[[0,4],[2,1],[1,0],[2,4],[0,1]],lines:[[0,3],[0,1],[1,2],[2,4]]},3:{points:[[1,4],[1,0],[0,1],[0,3],[1,2],[2,1],[2,3]],lines:[[0,3],[0,6],[1,2],[1,5],[4,5],[4,6]]},4:{points:[[0,0],[2,0],[2,4],[0,2],[2,2]],lines:[[0,3],[1,2],[3,4]]},5:{points:[[2,3],[1,2],[0,2],[0,4],[2,0],[1,4],[0,0]],lines:[[0,5],[0,1],[1,2],[2,6],[3,5],[4,6]]},6:{points:[[1,0],[0,1],[2,3],[1,4],[0,3],[1,2]],lines:[[0,1],[1,4],[2,5],[2,3],[3,4],[4,5]]},7:{points:[[1,4],[2,0],[0,0]],lines:[[0,1],[1,2]]},8:{points:[[1,2],[1,4],[1,0],[0,1],[0,3],[2,1],[2,3]],lines:[[0,6],[0,5],[0,3],[0,4],[1,4],[1,6],[2,3],[2,5]]},9:{points:[[1,2],[2,1],[1,0],[0,1],[2,3],[1,4]],lines:[[0,1],[0,3],[1,2],[1,4],[2,3],[4,5]]},":":{points:[[1,0],[1,1],[1,4],[1,3]],lines:[[0,1],[2,3]]},";":{points:[[1,3],[0,4],[1,1],[1,0]],lines:[[0,1],[2,3]]},"<":{points:[[2,0],[2,4],[0,2]],lines:[[0,2],[1,2]]},"=":{points:[[2,1],[0,1],[2,3],[0,3]],lines:[[0,1],[2,3]]},">":{points:[[2,2],[0,0],[0,4]],lines:[[0,1],[0,2]]},"?":{points:[[1,2],[2,1],[0,1],[1,0],[1,4],[1,3]],lines:[[0,1],[1,3],[2,3],[4,5]]},"@":{points:[[2,1],[0,1],[1,0],[0,3],[1,4],[1,2],[1,3],[2,2],[2,3]],lines:[[0,2],[1,2],[1,3],[3,4],[4,8],[5,7],[5,6],[6,7],[7,8]]},A:{points:[[2,4],[1,0],[0,2],[0,4],[2,2]],lines:[[0,4],[1,2],[1,4],[2,4],[2,3]]},B:{points:[[2,3],[2,1],[1,2],[0,4],[0,0],[1,0],[1,4]],lines:[[0,2],[0,6],[1,2],[1,5],[3,4],[3,6],[4,5]]},C:{points:[[2,3],[2,1],[0,1],[0,3],[1,4],[1,0]],lines:[[0,4],[1,5],[2,3],[2,5],[3,4]]},D:{points:[[1,4],[1,0],[0,4],[0,0],[2,1],[2,3]],lines:[[0,2],[0,5],[1,3],[1,4],[2,3],[4,5]]},E:{points:[[2,4],[2,0],[2,2],[0,4],[0,0],[0,2]],lines:[[0,3],[1,4],[2,5],[3,4]]},F:{points:[[0,0],[0,4],[2,2],[2,0],[0,2]],lines:[[0,3],[0,1],[2,4]]},G:{points:[[1,2],[2,2],[2,1],[2,3],[1,0],[1,4],[0,3],[0,1]],lines:[[0,1],[1,3],[2,4],[3,5],[4,7],[5,6],[6,7]]},H:{points:[[2,4],[2,0],[0,4],[0,0],[0,2],[2,2]],lines:[[0,1],[2,3],[4,5]]},I:{points:[[0,4],[2,4],[0,0],[2,0],[1,0],[1,4]],lines:[[0,1],[2,3],[4,5]]},J:{points:[[2,0],[2,3],[1,4],[0,3]],lines:[[0,1],[1,2],[2,3]]},K:{points:[[0,0],[0,4],[2,0],[2,4],[0,2]],lines:[[0,1],[2,4],[3,4]]},L:{points:[[0,0],[2,4],[0,4]],lines:[[0,2],[1,2]]},M:{points:[[2,4],[0,4],[1,2],[0,0],[2,0]],lines:[[0,4],[1,3],[2,3],[2,4]]},N:{points:[[2,0],[2,4],[0,0],[0,4]],lines:[[0,1],[1,2],[2,3]]},O:{points:[[1,0],[1,4],[0,3],[0,1],[2,1],[2,3]],lines:[[0,3],[0,4],[1,2],[1,5],[2,3],[4,5]]},P:{points:[[1,0],[0,0],[0,4],[1,2],[2,1],[0,2]],lines:[[0,1],[0,4],[1,2],[3,4],[3,5]]},Q:{points:[[2,4],[2,3],[2,1],[0,1],[0,3],[1,4],[1,0]],lines:[[0,5],[1,5],[1,2],[2,6],[3,4],[3,6],[4,5]]},R:{points:[[2,4],[2,1],[1,2],[0,4],[0,0],[1,0],[0,2]],lines:[[0,2],[1,2],[1,5],[2,6],[3,4],[4,5]]},S:{points:[[2,3],[2,1],[0,1],[0,3],[1,4],[1,0]],lines:[[0,2],[0,4],[1,5],[2,5],[3,4]]},T:{points:[[1,4],[2,0],[0,0],[1,0]],lines:[[0,3],[1,2]]},U:{points:[[2,3],[2,0],[0,0],[0,3],[1,4]],lines:[[0,4],[0,1],[2,3],[3,4]]},V:{points:[[1,4],[0,1],[0,0],[2,0],[2,1]],lines:[[0,1],[0,4],[1,2],[3,4]]},W:{points:[[0,4],[2,4],[1,2],[2,0],[0,0]],lines:[[0,2],[0,4],[1,2],[1,3]]},X:{points:[[2,0],[0,0],[2,4],[0,4]],lines:[[0,3],[1,2]]},Y:{points:[[1,4],[1,2],[0,0],[2,0]],lines:[[0,1],[1,2],[1,3]]},Z:{points:[[0,0],[2,4],[2,0],[0,4]],lines:[[0,2],[1,3],[2,3]]},"[":{points:[[1,0],[1,4],[2,4],[2,0]],lines:[[0,1],[0,3],[1,2]]},"\\":{points:[[2,3],[0,1]],lines:[[0,1]]},"]":{points:[[0,0],[0,4],[1,4],[1,0]],lines:[[0,3],[1,2],[2,3]]},"^":{points:[[0,1],[2,1],[1,0]],lines:[[0,2],[1,2]]},_:{points:[[0,4],[2,4]],lines:[[0,1]]},"`":{points:[[0,0],[1,1]],lines:[[0,1]]},a:{points:[[2,4],[2,3],[2,2],[0,2],[0,3],[1,4],[1,1]],lines:[[0,1],[1,2],[1,5],[2,6],[3,4],[3,6],[4,5]]},b:{points:[[1,4],[0,0],[0,4],[1,2],[2,3],[0,2]],lines:[[0,2],[0,4],[1,2],[3,4],[3,5]]},c:{points:[[1,1],[1,4],[0,3],[0,2],[2,2],[2,3]],lines:[[0,3],[0,4],[1,2],[1,5],[2,3]]},d:{points:[[0,3],[1,2],[2,4],[2,0],[1,4],[2,2]],lines:[[0,1],[0,4],[1,5],[2,4],[2,3]]},e:{points:[[2,3],[2,2],[0,2],[0,3],[1,4],[1,1]],lines:[[0,4],[1,2],[1,5],[2,3],[2,5],[3,4]]},f:{points:[[2,2],[1,1],[1,3],[0,4],[0,2],[0,3]],lines:[[0,1],[1,4],[2,5],[3,4]]},g:{points:[[0,5],[1,6],[2,5],[1,1],[1,4],[0,3],[0,2],[2,2],[2,3]],lines:[[0,1],[1,2],[2,7],[3,6],[3,7],[4,5],[4,8],[5,6]]},h:{points:[[2,4],[0,0],[0,4],[1,2],[2,3],[0,2]],lines:[[0,4],[1,2],[3,4],[3,5]]},i:{points:[[1,1],[1,0],[1,2],[2,4],[0,4],[1,4]],lines:[[0,1],[2,5],[3,4]]},j:{points:[[1,2],[1,6],[0,5],[2,5],[2,2]],lines:[[0,4],[1,3],[1,2],[3,4]]},k:{points:[[2,4],[0,4],[0,0],[2,3],[2,1],[1,2],[0,2]],lines:[[0,3],[1,2],[3,5],[4,5],[5,6]]},l:{points:[[0,2],[2,4],[0,0]],lines:[[0,1],[0,2]]},m:{points:[[0,4],[2,1],[1,1],[1,2],[2,4],[0,1],[0,2]],lines:[[0,5],[1,3],[1,4],[2,3],[2,6]]},n:{points:[[2,4],[0,4],[1,1],[2,2],[0,2],[0,1]],lines:[[0,3],[1,4],[2,3],[2,4],[4,5]]},o:{points:[[2,3],[2,2],[0,2],[0,3],[1,4],[1,1]],lines:[[0,4],[0,1],[1,5],[2,3],[2,5],[3,4]]},p:{points:[[2,3],[1,4],[0,6],[0,2],[1,2],[0,4]],lines:[[0,1],[0,4],[1,5],[2,3],[3,4]]},q:{points:[[1,2],[2,2],[2,6],[1,4],[0,3],[2,4]],lines:[[0,1],[0,4],[1,2],[3,4],[3,5]]},r:{points:[[0,4],[0,1],[1,1],[2,2],[0,2]],lines:[[0,1],[2,3],[2,4]]},s:{points:[[1,1],[1,4],[0,3],[0,2],[2,2],[2,3]],lines:[[0,3],[0,4],[1,2],[1,5],[3,5]]},t:{points:[[1,1],[0,2],[2,2],[1,4]],lines:[[0,3],[1,2]]},u:{points:[[1,4],[0,3],[0,1],[2,1],[2,3]],lines:[[0,1],[0,4],[1,2],[3,4]]},v:{points:[[2,1],[0,1],[1,4]],lines:[[0,2],[1,2]]},w:{points:[[2,1],[2,3],[0,1],[1,3],[0,4],[1,4]],lines:[[0,1],[1,5],[2,4],[3,4],[3,5]]},x:{points:[[2,1],[0,1],[1,2],[0,4],[2,4],[1,3]],lines:[[0,2],[1,2],[2,5],[3,5],[4,5]]},y:{points:[[2,1],[0,1],[1,2],[1,4]],lines:[[0,2],[1,2],[2,3]]},z:{points:[[0,4],[2,1],[2,4],[0,1]],lines:[[0,1],[0,2],[1,3]]},"{":{points:[[1,1],[1,3],[0,2],[2,0],[2,4],[1,4],[1,0]],lines:[[0,2],[0,6],[1,2],[1,5],[3,6],[4,5]]},"|":{points:[[1,0],[1,4]],lines:[[0,1]]},"}":{points:[[1,1],[1,3],[2,2],[1,0],[1,4],[0,4],[0,0]],lines:[[0,2],[0,3],[1,2],[1,4],[3,6],[4,5]]},"~":{points:[[1,1],[1,3],[2,2],[0,2]],lines:[[0,1],[0,3],[1,2]]}},NPos3d.VText=function(e){var t=this,n="VText";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";e=e||{},NPos3d.blessWith3DBase(t,e),t.string=e.string||"NEED INPUT",t.textAlign=e.textAlign||"center",t.characterWidth=2,t.characterHeight=4,t.characterHeightOffset=2,t.letterSpacing=e.letterSpacing||1,t.lineHeight=e.lineHeight||6,t.fontSize=e.fontSize||32,t.shape={points:[],lines:[]},t.stringCached=!1,t.font=e.font||NPos3d.Geom.font,t.cacheTextGeom()},NPos3d.VText.prototype={type:"VText",getStateString:function(){var e=this;return(e.string+e.textAlign+e.characterWidth+e.letterSpacing+e.lineHeight+e.fontSize).toString()},cacheTextGeom:function(){var e=this;e.lastGlobalCompositeMatrixString=!1,e.shape.points.length=0,e.shape.lines.length=0;var t=0,n={left:{charOffset:function(){return 0},spacingOffset:0},right:{charOffset:function(e){return-e},spacingOffset:e.letterSpacing},center:{charOffset:function(e){return-(e/2)},spacingOffset:e.letterSpacing/2}};if(!n.hasOwnProperty(e.textAlign))throw'You passed an unsupported textAlign type named "'+e.textAlign+'"';for(var o=n[e.textAlign].spacingOffset,i=e.string.split("\n"),r=0;r<i.length;r+=1){for(var s=i[r],a=s.length,l=n[e.textAlign].charOffset(a),c=0;a>c;c+=1){var p=s[c];if(" "===p);else if("	"===p)l+=1;else{if(!e.font.hasOwnProperty(p))throw'This font does not contain the character "'+ch+'"';for(var d=e.font[p],h=0;h<d.points.length;h+=1)e.shape.points.push([(d.points[h][0]+(e.characterWidth+e.letterSpacing)*l+o)*e.fontSize/e.characterHeight,(d.points[h][1]+e.lineHeight*r-e.characterHeightOffset)*e.fontSize/e.characterHeight,d.points[h][2]||0]);for(var u=0;u<d.lines.length;u+=1){var f=d.lines[u];e.shape.lines.push([f[0]+t,f[1]+t])}t=e.shape.points.length}l+=1}l=0}e.stringCached=e.getStateString()},update:function(e){var t=this;t.getStateString()!==t.stringCached&&t.cacheTextGeom(),t.shape.color=t.color},destroy:NPos3d.destroyFunc},NPos3d.Layout=NPos3d.Layout||{},NPos3d.Layout.ResponsivePoint=function(e){var t=this,n="ResponsivePoint";if(t.type!==n)throw n+" must be invoked using the `new` keyword.";if(e=e||{},"undefined"!=typeof e.offset&&"number"!=typeof e.offset.length)throw n+" constructor MUST be provided an `offset` array argument";if("undefined"==typeof e.scene||"undefined"==typeof e.scene.type||"Scene"!==e.scene.type)throw n+" constructor MUST be provided a `Scene` object argument";return t.offset=e.offset,t.scene=e.scene,t.scene.add(t),t.update(),t},NPos3d.Layout.ResponsivePoint.prototype=[],NPos3d.Layout.ResponsivePoint.prototype.type="ResponsivePoint",NPos3d.Layout.ResponsivePoint.prototype.update=function(){var e=this;e.offset[0]<0?e[0]=e.scene.cx+e.offset[0]:e.offset[0]>0?e[0]=e.offset[0]-e.scene.cx:e[0]=0,e.offset[1]<0?e[1]=e.scene.cy+e.offset[1]:e.offset[1]>0?e[1]=e.offset[1]-e.scene.cy:e[1]=0,e[2]=e.offset[2],"undefined"!=typeof e.offset[3]?(e[3]=e.offset[3],e.length=4):e.length=3},NPos3d.Scene.prototype.drawSprite=function(e,t){e.save(),e.translate(t.point2D.x,t.point2D.y),t.depthScale?e.scale(t.spriteScale*t.point2D.scale,t.spriteScale*t.point2D.scale):e.scale(t.spriteScale,t.spriteScale),e.rotate(t.spriteRot),t.numFrames>1?(t.frameState+=.3,t.frameState>=t.numFrames&&(t.frameState=0),e.drawImage(t.image,t.width*Math.floor(t.frameState),0,t.width,t.height,t.offset.x,t.offset.y,t.width,t.height)):e.drawImage(t.image,t.offset.x,t.offset.y),e.restore()},NPos3d.Scene.prototype.renderSprite=function(e){var t=this;if(e.updateMatrices(),e.loaded){var n=e.gPos;n[2]<t.camera.clipNear&&n[2]>t.camera.clipFar&&(e.point2D=t.camera.project3Dto2D(n),e.point2D.x+e.offset.x*e.point2D.scale<t.cx&&e.point2D.x-e.offset.x*e.point2D.scale>-t.cx&&e.point2D.y+e.offset.y*e.point2D.scale<t.cy&&e.point2D.y-e.offset.y*e.point2D.scale>-t.cy&&t.renderInstructionList.push({
method:t.drawSprite,args:e,z:n[2]}))}},NPos3d.renderSpriteFunc=function(){this.scene.renderSprite(this)},NPos3d.blessWithSpriteBase=function(e,t){if(!t.path)throw"You MUST provide an image `path` value on sprite type objects!";return NPos3d.blessWith3DBase(e,t),e.spriteRot=t.spriteRot||0,e.spriteScale=t.spriteScale||1,e.depthScale=t.depthScale||!1,e.numFrames=t.numFrames||1,e.frameState=e.numFrames,e.width=0,e.height=0,e.loaded=!1,e.image=new Image,e.image.onload=function(){e.width=e.image.width/e.numFrames,e.height=e.image.height,e.offset={x:-Math.round(e.width/2),y:-Math.round(e.height/2)},e.boundingBox=[[e.offset.x,e.offset.y,-32],[-e.offset.x,-e.offset.y,32]],e.loaded=!0},e.render=NPos3d.renderSpriteFunc,e.image.src=t.path,e},NPos3d.Sprite3D=function(e){var t=this,n="Sprite3D";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";return NPos3d.blessWithSpriteBase(t,e),t},NPos3d.Sprite3D.prototype={type:"Sprite3D",update:function(){},destroy:NPos3d.destroyFunc},NPos3d.Utils=NPos3d.Utils||{},NPos3d.Utils.Color={detectCSSColorType:function(e){return e.indexOf("#")>-1?"hex":e.toLowerCase().indexOf("rgb")>-1?"rgb":e.toLowerCase().indexOf("hsl")>-1?"hsl":e.toLowerCase().indexOf("hsv")>-1?"hsv":!1},hexToDec:function(e){return parseInt(e,16)},convertHexToRGBArray:function(e){var t,n,o,i=e.split(""),r=NPos3d.Utils.Color.hexToDec;return i.length<7?(t=r(""+i[1]+i[1]),n=r(""+i[2]+i[2]),o=r(""+i[3]+i[3])):(t=r(""+i[1]+i[2]),n=r(""+i[3]+i[4]),o=r(""+i[5]+i[6])),[t,n,o]},parenColorToArray:function(e){return e.replace(/rgb|hsl|hsv|a|\(|\)|;|%| /g,"").split(",").map(function(e,t){return 3>t?parseInt(e):parseFloat(e)})},rgbArrayToHLSArray:function(e){var t=NPos3d.Utils.Color.rgbToHsl(e[0],e[1],e[2]);return t[0]*=360,t[1]*=100,t[2]*=100,e.length>3&&t.push(e[3]),t},hslArrayToRGBArray:function(e){var t=NPos3d.Utils.Color.hslToRgb(e[0]%360/360,e[1]/100,e[2]/100),n=Math.round;return t[0]=n(t[0]),t[1]=n(t[1]),t[2]=n(t[2]),e.length>3&&t.push(e[3]),t},colorStringToHSLAArray:function(e){var t,n=NPos3d.Utils.Color,o=n.detectCSSColorType(e),i=[];return"hex"===o?(t=n.convertHexToRGBArray(e),t=n.rgbArrayToHLSArray(t),i.push(t[0],t[1],t[2],1)):"rgb"===o?(t=n.parenColorToArray(e),t=n.rgbArrayToHLSArray(t),i.push(t[0],t[1],t[2],t[3]||1)):"hsl"===o&&(t=n.parenColorToArray(e),i.push(t[0],t[1],t[2],t[3]||1)),i},colorStringToHSLAString:function(e){var t=NPos3d.Utils.Color,n=t.colorStringToHSLAArray(e),o=["hsla(",n[0]+",",n[1]+"%,",n[2]+"%,",n[3],");"];return o.join("")},colorStringToRGBAArray:function(e){var t,n=NPos3d.Utils.Color,o=n.detectCSSColorType(e),i=[];return"hex"===o?(t=n.convertHexToRGBArray(e),i.push(t[0],t[1],t[2],1)):"hsl"===o?(t=n.parenColorToArray(e),t=n.hslArrayToRGBArray(t),i.push(t[0],t[1],t[2],t[3]||1)):"rgb"===o&&(t=n.parenColorToArray(e),i.push(t[0],t[1],t[2],t[3]||1)),i},colorStringToRGBAString:function(e){var t=NPos3d.Utils.Color,n=["rgba(",t.colorStringToRGBAArray(e).join(),");"];return n.join("")},rgbToHsl:function(e,t,n){e/=255,t/=255,n/=255;var o,i,r=Math.max(e,t,n),s=Math.min(e,t,n),a=(r+s)/2;if(r==s)o=i=0;else{var l=r-s;switch(i=a>.5?l/(2-r-s):l/(r+s),r){case e:o=(t-n)/l+(n>t?6:0);break;case t:o=(n-e)/l+2;break;case n:o=(e-t)/l+4}o/=6}return[o,i,a]},hslToRgb:function(e,t,n){function o(e,t,n){return 0>n&&(n+=1),n>1&&(n-=1),1/6>n?e+6*(t-e)*n:.5>n?t:2/3>n?e+(t-e)*(2/3-n)*6:e}var i,r,s;if(0==t)i=r=s=n;else{var a=.5>n?n*(1+t):n+t-n*t,l=2*n-a;i=o(l,a,e+1/3),r=o(l,a,e),s=o(l,a,e-1/3)}return[255*i,255*r,255*s]}},NPos3d.Fx=NPos3d.Fx||{},NPos3d.Fx.Tween=function(e){var t=this,n="Tween";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";if(!e.object)throw"Fx.Tween requires an Object as the value for the `object` argument in the passed configuration object.";if(!e.properties)throw"Fx.Tween requires an Object as the value for the `properties` argument in the passed configuration object.";t.o=e.object,t.properties=e.properties,t.onUpdate=e.onUpdate||void 0,t.callback=e.callback||void 0,t.method=e.method||t.transitionLinear,t.frames=e.frames||60,t.frameState=0,t.frac=0,t.initialValues={},t.pos=[0,0,0];for(var o in t.properties)if(t.properties.hasOwnProperty(o)){var i=t.properties[o];void 0!==i.length?t.initialValues[o]=t.o[o].slice(0):t.initialValues[o]=t.o[o]}return t.o.add(this),t},NPos3d.Fx.Tween.prototype={type:"Tween",transitionLinear:function(e){return e},update:function(){var e=this;e.frac=e.method(e.frameState/e.frames);for(var t in e.properties)if(e.properties.hasOwnProperty(t)){var n=e.properties[t],o=e.initialValues[t];if(void 0!==n.length)for(var i=0;i<n.length;i+=1)e.o[t][i]=o[i]+(n[i]-o[i])*e.frac;else e.o[t]=o+(n-o)*e.frac}void 0!==e.onUpdate&&e.onUpdate(e),e.frameState+=1,e.frameState>e.frames&&(void 0!==e.callback&&e.callback(e),e.o.remove(e))}},NPos3d.Fx=NPos3d.Fx||{},NPos3d.Fx.Explosion=function(e){var t=this,n="Explosion";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";if(void 0===NPos3d.Utils||void 0===NPos3d.Utils.Color)throw"Please load the `NPos3d.Utils.Color` library prior to invoking the NPos3d.Fx.Explosion effects.";if(e=e||{},!e.object||!e.object.shape.lines||!e.object.transformedPointCache)throw"Fx.Explosion requires an Ob3D as the value for the `object` argument in the passed configuration object.";if(!e.scene||"Scene"!==e.scene.type)throw"Fx.Explosion requires a Scene as the value for the `scene` argument in the passed configuration object.";return t.o=e.object,e.scene.add(t),t},NPos3d.Fx.Explosion.prototype={type:"Explosion",update:function(){var e=this;e.lines=e.o.shape.lines,e.points=e.o.getTransformedPoints(),e.lines.forEach(function(t){var n=e.points[t[0]],o=e.points[t[1]],i=t[2]||e.o.shape.color||e.o.color||e.scene.strokeStyle;e.scene.add(new NPos3d.Fx.ExplosionLine({p1:n,p2:o,object:e.o,scene:e.scene,colorArray:NPos3d.Utils.Color.colorStringToRGBAArray(i)}))}),e.o.destroy(),e.destroy()},destroy:NPos3d.destroyFunc},NPos3d.Fx.ExplosionLine=function(e){var t=this,n="ExplosionLine";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";return e=e||{},e.shape={},NPos3d.blessWith3DBase(t,e),t.o=e.object,t.scene=e.scene,t.pos=t.o.gPos.slice(0),t.p1=t.subVel(e.p1.slice(0),t.pos),t.p2=t.subVel(e.p2.slice(0),t.pos),t.midpoint=t.getMidpoint(),t.addVel(t.pos,t.midpoint),t.subVel(t.p1,t.midpoint),t.subVel(t.p2,t.midpoint),t.shape.points=[t.p1,t.p2],t.shape.lines=[[0,1]],t.colorArray=e.colorArray,t.vel=e.vel||[t.rint(2),t.rint(2),t.rint(2)],t.rotVel=e.rotVel||[t.rneg(2)*deg,t.rneg(2)*deg,t.rneg(2)*deg],t.lifespan=50+t.rint(100),t.life=t.lifespan,t.scene.add(t),t},NPos3d.Fx.ExplosionLine.prototype={type:"ExplosionLine",rneg:function(e){return(2*Math.random()-1)*e},rint:function(e){return Math.round((2*Math.random()-1)*e)},rpos:function(e){return Math.random()*e},rintpos:function(e){return Math.round(Math.random()*e)},getMidpoint:function(){var e=this,t=[e.p2[0]-e.p1[0],e.p2[1]-e.p1[1],e.p2[2]-e.p1[2]];return t[0]/=2,t[1]/=2,t[2]/=2,t[0]+=e.p1[0],t[1]+=e.p1[1],t[2]+=e.p1[2],t},addVel:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e},subVel:function(e,t){return e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e},update:function(){var e=this,t=e.colorArray;e.addVel(e.pos,e.vel),e.addVel(e.rot,e.rotVel),e.color=["rgba(",t[0],",",t[1],",",t[2],",",t[3]*(e.life/e.lifespan),")"].join(""),e.life-=1,e.life<1&&e.destroy()}},NPos3d.Geom.Circle=function(e){var t=this,n="Circle";if(t.type!==n)throw"You must use the `new` keyword when invoking the "+n+" constructor.";return e=e||{},t.color=e.color||void 0,t.segments=e.segments||12,t.offset=e.offset||0,t.points=[],t.lines=[],t.radius=e.radius||20,t.axies=e.axies||[0,1,2],t.formCircle(),t},NPos3d.Geom.Circle.prototype={type:"Circle",formCircle:function(){var e,t,n,o=this,i=NPos3d.Maths,r=i.tau/o.segments;for(o.points=[],o.lines=[],e=0;e<o.segments;e+=1)t=[],n=r*e+o.offset,t[o.axies[0]]=i.cos(n)*o.radius,t[o.axies[1]]=i.sin(n)*o.radius,t[o.axies[2]]=0,o.points.push(t),e>0&&e<=o.segments&&(o.lines.push([e-1,e]),e===o.segments-1&&o.lines.push([e,0]));return o}},NPos3d.Geom.Sphere=function(e){var t={};e=e||{},t.color=e.color||void 0,t.points=[],t.lines=[],t.order=e.order||"xzy";for(var n=e.radius||20,o=e.segments||12,i=tau/o,r=e.rings||8,s=pi/(r-1),a=0,l=0,c=0;r>c;c+=1){var p=Math.cos(s*c)*n;if(0===c||c===r-1){if("xyz"===t.order||"yxz"===t.order?t.points.push([0,0,p]):"xzy"===t.order||"yzx"===t.order?t.points.push([0,p,0]):("zxy"===t.order||"zyx"===t.order)&&t.points.push([p,0,0]),a=t.points.length-1,c===r-1)for(l=0;o>l;l+=1)t.lines.push([a-l-1,a])}else{var d=Math.sin(s*c)*n;for(l=0;o>l;l+=1){var h=Math.sin(i*l)*d,u=Math.cos(i*l)*d;"xyz"===t.order?t.points.push([h,u,p]):"xzy"===t.order?t.points.push([h,p,u]):"zyx"===t.order?t.points.push([p,u,h]):"zxy"===t.order?t.points.push([p,h,u]):"yxz"===t.order?t.points.push([u,h,p]):"yzx"===t.order&&t.points.push([u,p,h]),a=t.points.length-1,o+1>a&&t.lines.push([0,a]),a>1&&l>0&&t.lines.push([a-1,a]),l===o-1&&t.lines.push([a-(o-1),a]),a>o&&t.lines.push([a-o,a])}}}return t},NPos3d.Geom.Lathe=function(e){var t=this,n="Lathe";if(t.type!==n)throw n+" constructor requires the use of the `new` keyword.";if("object"!=typeof e.shape||"object"!=typeof e.shape.points||"number"!=typeof e.shape.points.length)throw n+" constructor requires the that the configuration object contains a `shape` property containing an object with a `points` array.";t.shape=e.shape,t.axis=0===e.axis?0:e.axis||1,t.segments=e.segments||12,t.frac=e.frac||tau,t.points=[],t.lines=[],t.generate()},NPos3d.Geom.Lathe.prototype={type:"Lathe",generate:function(){var e,t,n,o,i,r=this,s=NPos3d.Maths,a=r.frac/parseInt(r.segments),l=[0,0,0],c=s.makeMat4(),p=r.shape.points.length,d=r.shape.lines.length;for(r.points.length=0,r.lines.length=0,e=0;e<r.segments;e+=1){for(l[r.axis]=a*e,s.eulerToMat4(l,[0,1,2],c),t=0;p>t;t+=1)n=r.shape.points[t],r.points.push(s.p3Mat4Mul(n,c)),r.shape.lines.length>0&&(e>0&&r.lines.push([e*p+t,(e-1)*p+t]),e===r.segments-1&&r.lines.push([e*p+t,t]));for(o=0;d>o;o+=1)i=r.shape.lines[o],r.lines.push([e*p+i[0],e*p+i[1]])}}},NPos3d.Geom.Twist=function(e){var t=this,n="Twist";if(t.type!==n)throw n+" constructor requires the use of the `new` keyword.";if("object"!=typeof e.shape||"object"!=typeof e.shape.points||"number"!=typeof e.shape.points.length)throw n+" constructor requires the that the configuration object contains a `shape` property containing an object with a `points` array.";t.shape=e.shape,0===e.axis?t.axis=0:t.axis=e.axis||1,t.points=[],t.factor=0===e.factor?0:e.factor||tau,t.offset=e.offset||0,t.generate()},NPos3d.Geom.Twist.prototype={type:"Twist",generate:function(){var e,t,n,o=this,i=NPos3d.Maths,r=i.nGetBounds(o.shape.points),s=r[1][o.axis]-r[0][o.axis],a=o.shape.points.length,l=[0,0,0],c=i.makeMat4();for(o.points.length=0,e=0;a>e;e+=1)t=o.shape.points[e].slice(),n=(t[o.axis]-r[0][o.axis])/s+o.offset,l[o.axis]=n*o.factor,i.eulerToMat4(l,[0,1,2],c),i.p3Mat4Mul(t,c,t),o.points.push(t);void 0!==o.shape.lines&&(o.lines=o.shape.lines.slice())}};